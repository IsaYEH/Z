const API_BASE='/api';const PALACES=['命宮','兄弟宮','夫妻宮','子女宮','財帛宮','疾厄宮','遷移宮','交友宮','官祿宮','田宅宮','福德宮','父母宮'];function getHeavenlyStem(y){const s=['Jia','Yi','Bing','Ding','Wu','Ji','Geng','Xin','Ren','Gui'];return s[(y-4)%10]}function getYearSkyValue(){const sel=document.getElementById('yearSkySelect')?.value||'auto';if(sel!=='auto')return sel;const y=Number((document.getElementById('date').value||'1991-06-28').slice(0,4));return getHeavenlyStem(y)}function normalizeTime(raw){if(!raw)return'12:00';let t=String(raw).trim();const am=t.includes('上午')||/am/i.test(t),pm=t.includes('下午')||/pm/i.test(t);t=t.replace('上午','').replace('下午','').replace(/ ?am/i,'').replace(/ ?pm/i,'').trim();let[h,m='00']=t.split(':');h=parseInt(h||'12',10);m=parseInt(m||'0',10);if(pm&&h<12)h+=12;if(am&&h===12)h=0;h=Math.max(0,Math.min(23,h));m=Math.max(0,Math.min(59,m));return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')}function ensureGrid(){const g=document.getElementById('zwGrid');if(g.children.length)return;[...PALACES.map(p=>'p-'+p),'c-1','c-2','c-3','c-4'].forEach(id=>{const d=document.createElement('div');d.id=id;d.className=id.startsWith('p-')?'zw-palace':'zw-center';if(id.startsWith('p-'))d.innerHTML=`<h4>${id.replace('p-','')}</h4><div><span class='badge'>(無)</span></div>`;g.appendChild(d)});}function badge(s){const c=s.type==='major'?'major':s.type==='inauspicious'?'inauspicious':'aux';return `<span class='badge ${c}'>${s.name}</span>`}function decorate(stars,t){if(!t)return stars.map(badge);const map={'祿':'t-lu','權':'t-quan','科':'t-ke','忌':'t-ji'};const rev={};Object.entries(t).forEach(([k,v])=>(rev[v]??=[]).push(k));return stars.map(s=>badge(s)+(rev[s.name]||[]).map(x=>`<span class='badge ${map[x]}'>(${x})</span>`).join(''))}function renderGrid(chart){ensureGrid();PALACES.forEach(p=>{const el=document.getElementById('p-'+p);const stars=decorate(chart?.natal?.stars?.[p]||[],chart?.natal?.transforms).join('');el.innerHTML=`<h4>${p}</h4><div>${stars||"<span class='badge'>(無)</span>"}</div>`});document.getElementById('c-1').textContent=`五行局：${chart?.natal?.fiveElementBureau||'—'}`;document.getElementById('c-2').textContent=`命主/身主：${chart?.meta?.lifeLord||'—'} / ${chart?.meta?.bodyLord||'—'}`;document.getElementById('c-3').textContent=`三方四正：${(chart?.aspects?.sanFangSiZheng||[]).map(g=>g.join('↔')).join('，')||'—'}`;document.getElementById('c-4').textContent=`煞曜：${(chart?.aspects?.sha||[]).map(s=>s.name+'·'+s.palace).join('，')||'—'}`;const pre=document.getElementById('rawJson');if(pre)pre.textContent=JSON.stringify(chart,null,2);}async function createChart({date,time,place,yearSky}){const r=await fetch(`${API_BASE}/charts`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date,time,place,tz:'+08:00',lat:25.033,lon:121.565,ruleset:'wenmo-1.0',yearSky})});return r.json()}async function handleSubmit(e){e?.preventDefault?.();const date=document.getElementById('date').value||'1991-06-28';const time=normalizeTime(document.getElementById('time').value||'11:00');const place=document.getElementById('place').value||'台北';const yearSky=getYearSkyValue();renderGrid(await createChart({date,time,place,yearSky}))}document.getElementById('formRoot')?.addEventListener('submit',handleSubmit);document.getElementById('gen')?.addEventListener('click',handleSubmit);(async()=>{try{renderGrid(await createChart({date:'1991-06-28',time:'11:00',place:'台北',yearSky:getHeavenlyStem(1991)}))}catch(e){const pre=document.getElementById('rawJson');if(pre)pre.textContent=String(e)}})();